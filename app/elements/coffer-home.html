<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/sc-swiper/sc-swiper.html">

<dom-module id="coffer-home">

  <template>

    <style>
      .coffer-summary{
        max-width:800px;
        margin:auto;
        padding-top:15px;
        text-align:center;
      }
      .coffer-summary a{
        background:url("/images/icon-coffer.png") 50% 10px no-repeat #f6f6f6;
        display:inline-block;
        width:29%;
        margin:0 1%;padding:43px 0 5px 0;
        text-decoration:none;
        font-weight:700;
        color:var(--app-primary-color);
        border-radius:20px;
      }
      .coffer-summary a span{
        display:block;
        margin-top:-5px;
        opacity:.7;
        font-size:18px;
        color:var(--app-primary-text-color);
      }
      ul,ol{
        list-style:none;
        margin:0;
        padding:0;
      }
      ul{margin-top:20px;}
      a{
        text-decoration:none
      }
      li:nth-child(even){
        background-color:rgba(0,0,0,.05);
      }

      .item {
        display: block;
        text-decoration: none;
        text-align: center;
        margin-bottom: 40px;
      }

      paper-card.rate { 
        @apply(--layout-horizontal); 
        padding: 20px;
        border-radius: 8px;
        background-color: white;
        border: 1px solid #ddd;
        max-width: 800px;
        margin: 16px auto 0 auto;
      }
      .rate-image {
        width: 100px;
        height: 150px;
        border-radius: 20px;
        box-sizing: border-box;
        background-color: #DDD;
      }
      .rate-content {
        padding: 0 16px;
        @apply(--layout-flex);
        float: left;
      }
      .rate-header { @apply(--paper-font-headline); }
      .rate-name { color: var(--paper-grey-600); margin: 10px 0; }

      paper-spinner{
        position:absolute;
        top:30%;
        left:50%;
      }
    </style>

    

    <things-ajax auto="" id="get-resource" method="GET" resource-action="index" resource-url="units" page="[[page]]" limit="[[limit]]" last-response="{{unitResource}}">
    </things-ajax>

    <things-ajax auto="" id="coffer-search" method="GET" resource-action="index" resource-url="coffers" page="[[page]]" limit="[[limit]]" last-response="{{cofferResource}}">
    </things-ajax>

    <things-ajax id="get-unit" method="GET" resource-action="index" resource-url="units" page="[[page]]" limit="[[limit]]" last-response="{{addUnit}}">
    </things-ajax>

    <sc-swiper pagination on-click="_clickSwiper">
      <template is="dom-repeat" items="[[_showCofferSummary(cofferResource.items)]]" as="coffer">
        <div class="coffer-summary">
          <a href="#" on-click="_clickSwiper" name="[[coffer.coffer_id_one]]">[[coffer.coffer_name_one]]<span>[[coffer.coffer_count_one]]</span></a>
          <a href="#" on-click="_clickSwiper" name="[[coffer.coffer_id_two]]">[[coffer.coffer_name_two]]<span>[[coffer.coffer_count_two]]</span></a>
          <a href="#" on-click="_clickSwiper" name="[[coffer.coffer_id_three]]">[[coffer.coffer_name_three]]<span>[[coffer.coffer_count_three]]</span></a>        
        </div>
      </template>
    </sc-swiper>

    <paper-spinner alt="Loading contacts list" active="[[active]]"></paper-spinner>

    <template is="dom-repeat" items="{{unitResource.items}}" as="unitItem">
      <a href="#" on-click="_clickUnit" name="[[unitItem.id]]"><coffer-unit-list-item item="[[unitItem]]"></coffer-unit-list-item></a>
    </template>

    <iron-scroll-threshold scroll-target="document" on-lower-threshold="loadMoreData" id="threshold">
      <paper-spinner alt="Loading contacts list" active="[[active]]"></paper-spinner>
    </iron-scroll-threshold>

  </template>

  <script>

    Polymer({

      is: 'coffer-home',

      properties: {

        categories: {
          type: Array
        },

        visible: {
          type: Boolean,
          observer: '_visibleChanged'
        },

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 10
        },

        addUnit: Object,

        unitResource: Object

      },

      listeners: {
        'get-unit.things-ajax-response' : '_handleSaveSuccess',
        'get-unit.things-ajax-error' : '_handleSaveFailure'
      },

      _visibleChanged: function(visible) {
        if (visible) {
          // var ajax = this.$['coffer-search'];
          // ajax.generateRequest();
          

            // $('#reader').html5_qrcode(function (data) {
            //   console.log(data);
            //   location.replace("unit-detail-list/unit/Hamilton%20AUTO%2040MM");
            // },
            // function (error) {
            //   // this.location.href("http://localhost:5000/unit-list/unit"); 
            // }, function (videoError) {
            //   // console.log(videoError);
            // });
          this.page = 1;
          this.unitListReload();
          this.fire('change-section', { title: 'Home' });
        } else {
          // $('#reader').html5_qrcode_stop();
        }
      },

      _getItemHref: function(item) {
        // By returning null when `itemId` is undefined, the href attribute won't be set and
        // the link will be disabled.
        return item.id ? ['/unit-detail-list', item.id].join('/') : null;
      },

      _getItemCofferHref: function(id) {
        // By returning null when `itemId` is undefined, the href attribute won't be set and
        // the link will be disabled.
        return id ? ['/coffer-detail', id].join('/') : null;
      },

      unitListReload: function() {
        var ajax = this.$['get-resource'];
        ajax.generateRequest();
      },

      _imageSrc: function(thumbnail) {
        if(thumbnail != null) {
          var setting = document.querySelector('#setting');
          return setting.get('globals.baseUrl') + "/download/" + thumbnail
        }
      },

      _showCofferSummary: function(items) {
        var arr = [];
        var obj = {};
        var cnt = items.length / 3;
        cnt = parseInt(cnt);
        var remainder = items.length % 3;
        remainder = parseInt(remainder);

        if(cnt == 0) {
          if(remainder == 1) {
            obj.coffer_id_one = items[i].id;
            obj.coffer_name_one = items[i].name;
            obj.coffer_count_one = items[i].count;

            arr.push(obj);
          } else if(remainder == 2) {
            obj.coffer_id_one = items[i].id;
            obj.coffer_name_one = items[i].name;
            obj.coffer_count_one = items[i].count;
            obj.coffer_id_two = items[i+1].id;
            obj.coffer_name_two = items[i+1].name;
            obj.coffer_count_two = items[i+1].count;

            arr.push(obj);
          }
        } else {

          for(var i = 0 ; i < cnt ; i++) {
            obj = {};
            var j = 3*i;

            obj.coffer_id_one = items[j].id;
            obj.coffer_name_one = items[j].name;
            obj.coffer_count_one = items[j].count;
            obj.coffer_id_two = items[j+1].id;
            obj.coffer_name_two = items[j+1].name;
            obj.coffer_count_two = items[j+1].count;
            obj.coffer_id_three = items[j+2].id;
            obj.coffer_name_three = items[j+2].name;
            obj.coffer_count_three = items[j+2].count;

            arr.push(obj);
          }
          obj = {};
          if(remainder == 1) {
            obj.coffer_id_one = items[cnt*3].id;
            obj.coffer_name_one = items[cnt*3].name;
            obj.coffer_count_one = items[cnt*3].count;

            arr.push(obj);
          } else if(remainder == 2) {
            obj.coffer_id_one = items[cnt*3].id;
            obj.coffer_name_one = items[cnt*3].name;
            obj.coffer_count_one = items[cnt*3].count;
            obj.coffer_id_two = items[cnt*3+1].id;
            obj.coffer_name_two = items[cnt*3+1].name;
            obj.coffer_count_two = items[cnt*3+1].count;

            arr.push(obj);
          }
        }

        return arr;
      },

      _clickSwiper: function(e) {
        alert(e.currentTarget.name);
        // document.querySelector("coffer-app").route.path = '/coffer-coffer-detail-list/' + e.target.name;
        // document.querySelector("coffer-app").page = 'coffer-coffer-detail-list';
      },

      _clickUnit: function(e) {
        // alert(e.currentTarget.name);
        document.querySelector("coffer-app").route.path = '/coffer-unit-detail-list/' + e.currentTarget.name;
        document.querySelector("coffer-app").page = 'coffer-unit-detail-list';
      },

      loadMoreData: function() {
        this.async(function () {
          this.$.threshold.clearTriggers();
          if(this.visible && this.unitResource != null) {
            if(this.unitResource.items.length >= this.unitResource.total) return;

            this.page++;
            this.active = true;
            var ajax = this.$['get-unit'];
            ajax.generateRequest();
          }
        });
      },

      _handleSaveSuccess: function(event) {
        if(this.addUnit.items != null) {
          for(var i = 0 ; i < this.addUnit.items.length ; i++) {
            this.push('unitResource.items',this.addUnit.items[i]);
          }
          this.active = false;
        }
      },

      _handleSaveFailure: function(event) {
        alert('fail');
      },

    });

  </script>

</dom-module>
