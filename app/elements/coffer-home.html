<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">

<dom-module id="coffer-home">

  <template>

    <style>
      a{
        display:block;
        text-decoration:none
      }
      paper-card.rate {
        @apply(--layout-horizontal);
        padding: 20px;
        max-width: 800px;
        margin: 16px auto 0 auto;
      }
      paper-spinner{
        position:absolute;
        top:60%;
        left:50%;
      }
      a:nth-child(even){
        background-color:rgba(0,0,0,.05) !important
      }
    </style>



    <things-ajax auto="" id="get-resource" method="GET" resource-action="index" resource-url="units" page="[[page]]" limit="[[limit]]" last-response="{{unitResource}}">
    </things-ajax>

    <things-ajax auto="" id="coffer-search" method="GET" resource-action="index" resource-url="coffers" page="[[page]]" limit="[[limit]]" last-response="{{cofferResource}}">
    </things-ajax>

    <things-ajax id="get-unit" method="GET" resource-action="index" resource-url="units" page="[[page]]" limit="[[limit]]" last-response="{{addUnit}}">
    </things-ajax>

    <paper-spinner alt="Loading contacts list" active="[[active]]"></paper-spinner>

    <template is="dom-repeat" items="{{unitResource.items}}" as="unitItem">
      <a href="{{baseUrl}}unit-detail-list/[[unitItem.id]]" name="[[unitItem.id]]"><coffer-unit-list-item item="[[unitItem]]"></coffer-unit-list-item></a>
    </template>

    <iron-scroll-threshold scroll-target="document" on-lower-threshold="loadMoreData" id="threshold">
    </iron-scroll-threshold>

  </template>

  <script>

    Polymer({

      is: 'coffer-home',

      properties: {

        categories: {
          type: Array
        },

        visible: {
          type: Boolean,
          observer: '_visibleChanged'
        },

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 10
        },

        addUnit: Object,

        unitResource: Object

      },

      listeners: {
        'get-unit.things-ajax-response' : '_handleSaveSuccess',
        'get-unit.things-ajax-error' : '_handleSaveFailure'
      },

      behaviors: [
        Things.GlobalBehavior
      ],

      _visibleChanged: function(visible) {
        if (visible) {
          this.page = 1;
          this.unitListReload();
          this.fire('change-section', { title: 'Home' });
        } else {
          // $('#reader').html5_qrcode_stop();
        }
      },

      unitListReload: function() {
        var ajax = this.$['get-resource'];
        ajax.generateRequest();
      },

      _imageSrc: function(thumbnail) {
        if(thumbnail != null) {
          var thumbnailIds = thumbnail.split(',');
          return this.get('globals.baseUrl') + "/download/public/" + thumbnailIds[0];
        }
      },

      _showCofferSummary: function(items) {
        var arr = [];
        var obj = {};
        var cnt = items.length / 3;
        cnt = parseInt(cnt);
        var remainder = items.length % 3;
        remainder = parseInt(remainder);

        if(cnt == 0) {
          if(remainder == 1) {
            obj.coffer_id_one = items[i].id;
            obj.coffer_name_one = items[i].name;
            obj.coffer_count_one = items[i].count;

            arr.push(obj);
          } else if(remainder == 2) {
            obj.coffer_id_one = items[i].id;
            obj.coffer_name_one = items[i].name;
            obj.coffer_count_one = items[i].count;
            obj.coffer_id_two = items[i+1].id;
            obj.coffer_name_two = items[i+1].name;
            obj.coffer_count_two = items[i+1].count;

            arr.push(obj);
          }
        } else {

          for(var i = 0 ; i < cnt ; i++) {
            obj = {};
            var j = 3*i;

            obj.coffer_id_one = items[j].id;
            obj.coffer_name_one = items[j].name;
            obj.coffer_count_one = items[j].count;
            obj.coffer_id_two = items[j+1].id;
            obj.coffer_name_two = items[j+1].name;
            obj.coffer_count_two = items[j+1].count;
            obj.coffer_id_three = items[j+2].id;
            obj.coffer_name_three = items[j+2].name;
            obj.coffer_count_three = items[j+2].count;

            arr.push(obj);
          }
          obj = {};
          if(remainder == 1) {
            obj.coffer_id_one = items[cnt*3].id;
            obj.coffer_name_one = items[cnt*3].name;
            obj.coffer_count_one = items[cnt*3].count;

            arr.push(obj);
          } else if(remainder == 2) {
            obj.coffer_id_one = items[cnt*3].id;
            obj.coffer_name_one = items[cnt*3].name;
            obj.coffer_count_one = items[cnt*3].count;
            obj.coffer_id_two = items[cnt*3+1].id;
            obj.coffer_name_two = items[cnt*3+1].name;
            obj.coffer_count_two = items[cnt*3+1].count;

            arr.push(obj);
          }
        }

        return arr;
      },

      loadMoreData: function() {
        this.async(function () {
          this.$.threshold.clearTriggers();
          if(this.visible && this.unitResource != null) {
            if(this.unitResource.items.length >= this.unitResource.total) return;

            this.page++;
            this.active = true;
            var ajax = this.$['get-unit'];
            ajax.generateRequest();
          }
        });
      },

      _handleSaveSuccess: function(event) {
        if(this.addUnit && this.addUnit.items != null) {
          for(var i = 0 ; i < this.addUnit.items.length ; i++) {
            this.push('unitResource.items',this.addUnit.items[i]);
          }
          this.active = false;
        }
      },

      _handleSaveFailure: function(event) {
        alert('fail');
        this.page--;
        this.active = false;
      },

    });

  </script>

</dom-module>
