<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="coffer-category-data.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="coffer-unit-list-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">
<link rel="import" href="../bower_components/things-ajax/things-ajax.html">

<dom-module id="coffer-coffer-list">
	<template>
		<style>
      paper-fab{
        @apply(--things-coffer-fab)
      }
      paper-fullscreen-dialog{
        height:80% !important;
        margin-top:9%;
        overflow:hidden;
      }
      iron-image{
        width:48%;
        max-height:200px;
      }
      iron-image *{margin:auto;}
      iron-image::shadow img{
        max-width:200px;
        max-height:200px;
      }
      ul,ol{list-style:none;margin:0;padding:0;}
      ul{
        overflow:hidden
      }
      .tile__list{
        width:47%;
        margin:20px 0 0 2%;
        float:left;
        border-bottom:1px solid #efefef;
      }
      .title-name{
        @apply(--things-coffer-title)
      }
      .title-name span{
        @apply(--things-coffer-desc);
        float:right;
      }
    </style>

		<!-- <app-route
        route="[[route]]"
        pattern="/:category"
        data="{{routeData}}"></app-route> -->

    <things-ajax
      auto=""
      id="coffer-search"
      method="GET"
      resource-action="index"
      resource-url="coffers"
      page="[[page]]"
      limit="[[limit]]"
      last-response="{{cofferResource}}">
    </things-ajax>

    <things-ajax
      id="create-coffer-ajax"
      resource-action="create"
      resource-url="[[route.prefix]]">
    </things-ajax>

    <ul hidden$="[[failure]]">

      <template is="dom-repeat" items=[[cofferResource.items]] as="coffer">
        <a href$="[[_getItemHref(coffer)]]">
          <div class="tile__list">
            <div class="tile__name title-name">
              [[coffer.name]]
              <span>unit : [[coffer.count]]</span>
            </div>
            <iron-image src="[[_imageSrc(coffer.thumbnail_id)]]"></iron-image>
            <iron-image src="[[_imageSrc(coffer.thumbnail_id_sec)]]"></iron-image>
          </div>
        </a>
      </template>

      <paper-fab noink id="add-coffer" icon="add" title="add coffer"></paper-fab>
      <paper-fullscreen-dialog id="new-coffer">
        <h2>New Coffer</h2>
        <paper-button id="create-coffer" affirmative dialog-confirm>create</paper-button>
        <coffer-coffer-new id="new-coffer-data"></coffer-coffer-new>
      </paper-fullscreen-dialog>
    </ul>
	</template>

	<script>

    Polymer({

      is: 'coffer-coffer-list',

      properties: {

        category: Object,

        route: Object,

        routeData: Object,

        visible: {
          type: Boolean,
          observer: '_visibleChanged'
        },

        failure: Boolean,

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 30
        }

      },

      listeners: {
        'add-coffer.tap': 'onTapAddCoffer',
        'new-coffer.iron-overlay-closed': 'onNewCofferDialogClosed',
        'create-coffer-ajax.things-ajax-response' : '_handleSaveSuccess',
        'create-coffer-ajax.things-ajax-error' : '_handleSaveFailure'
      },

      _visibleChanged: function(visible) {
        if (visible) {
          this.cofferListReload();
          this.fire('change-section', { title: 'coffer' });
        } 
      },

      _getItemHref: function(item) {
        // By returning null when `itemId` is undefined, the href attribute won't be set and
        // the link will be disabled.
        return item.id ? ['/coffer-detail', item.id].join('/') : null;
      },

      _getPluralizedQuantity: function(quantity) {
        if (!quantity) {
          return '';
        }
        var pluralizedQ = quantity === 1 ? 'item' : 'items';
        return  '(' + quantity + ' ' + pluralizedQ + ')';
      },

      onTapAddCoffer: function(e) {
        this.$["new-coffer"].open();
      },

      onNewCofferDialogClosed: function(e) {
        if(!e.detail.confirmed)
          return

        this.createResource(this.$['new-coffer-data'].object);
      },

      createResource: function(data) {
        var row = {
          'name' : data.name,
          'coffer_color' : data.color
        };

        var ajax = this.$['create-coffer-ajax'];
        ajax.body = row;
        ajax.generateRequest();
      },

      cofferListReload: function() {
        var ajax = this.$['coffer-search'];
        ajax.generateRequest();
      },

      /**
       * 저장 성공시 액션
       *
       * @param {Object} event
       */
      _handleSaveSuccess: function(event) {
        this.cofferListReload();
      },

      /**
       * 저장 실패시 액션
       *
       * @param {Object} event
       */
      _handleSaveFailure: function(event) {
        alert('fail');
      },

      _imageSrc: function(thumbnail) {
        if(thumbnail != null) {
          var setting = document.querySelector('#setting');
          return setting.get('globals.baseUrl') + "/download/" + thumbnail
        }
      }

    });

  </script>
</dom-module>