<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<dom-module id="coffer-unit-new">
  <template>

    <style>
    </style>

    <things-ajax
      auto
      id="get-resource"
      method="GET"
      resource-url="coffers"
      last-response="{{cofferResource}}">
    </things-ajax>


    <form is="iron-form" id="unitNewForm" method="post" enctype="multipart/form-data">
      <paper-input name="name" label="name" type="string" value="{{name}}"></paper-input>
      <paper-textarea name="content" label="description" type="string" value="{{description}}"></paper-textarea>
      <paper-dropdown-menu label="group" name="group" 
                         value="{{group}}"
                         vertical-align="top"
                         horizontal-align="left">

        <paper-menu class="dropdown-content" selected="{{selectedGroup(group)}}">
          <template is="dom-repeat" items="{{cofferResource.items}}">
            <paper-item>{{item.name}}</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>

      <paper-input name="file" label="file" type="file" value="{{file}}"></paper-input>

      <paper-button id="submitButton" raised on-click="_unitCreate">Submit</paper-button>
    </form>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'coffer-unit-new',

        properties: {
          cofferResource: Object,

          cofferId: String,

          data: String
        },

        selectedGroup: function(group) {
          if(!this.cofferResource)
            return

          for(var i = 0;i < this.cofferResource.items.length;i++) {
            if(this.cofferResource.items[i].name == group) {
              this.cofferId = this.cofferResource.items[i].id;
              return this.cofferResource.items[i].id;
            }
          }
        },

        _unitCreate: function(e) {
          var form = this.$.unitNewForm;
          var oData = new FormData(form);
          var self = this;

          var result = {
            'name' : form.elements['name'].value,
            'cofferId' : this.cofferId,
            'content' : form.elements['content'].value,
          };

          oData.append('item', JSON.stringify(result));
          var myRequest = new XMLHttpRequest();
          myRequest.onreadystatechange = function(){
            if(myRequest.readyState == 4 && (myRequest.status == 200 || myRequest.status == 201)){
              self.fire(self.data + '-close', { title: 'close' });
            } 
          };

          var setting = document.querySelector('#setting');
          myRequest.withCredentials = true;
          myRequest.open('post', setting.get('globals.baseUrl') + '/units',true);
          myRequest.send(oData);
        }

      })
    })();
  </script>
</dom-module>
