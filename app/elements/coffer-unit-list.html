<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="coffer-category-data.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="coffer-unit-list-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">
<link rel="import" href="../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../bower_components/file-upload/file-upload.html">
<link rel="import" href="../bower_components/things-upload/things-file-upload.html">
<link rel="import" href="../bower_components/sc-upload/sc-upload.html">

<dom-module id="coffer-unit-list">

  <template id="ap">

    <style>
      :host{
      }
      paper-fab{
        @apply(--things-coffer-fab)
      }
      paper-fullscreen-dialog{
        height:80% !important;
        margin-top:9%;
        overflow:hidden;
      }
      header{
        padding:10px 5px 0 0;
        text-align:right
      }
      ul,ol{
        list-style:none;
        margin:0;
        padding:0;
      }
      a{text-decoration:none}
      li:nth-child(even){
        background-color:rgba(0,0,0,.05);
      }
    </style>

    

    <things-ajax auto="" id="get-resource" method="GET" resource-action="index" resource-url="units" page="[[page]]" limit="[[limit]]" last-response="{{resource}}">
    </things-ajax>

    <header>
      <span>[[_getPluralizedQuantity(resource.items.length)]]</span>
    </header>

    <ul hidden$="[[failure]]">
      <template is="dom-repeat" items="{{resource.items}}" as="unitItem">
        <a href="#" on-click="_clickUnit" name="[[unitItem.id]]"><coffer-unit-list-item item="[[unitItem]]"></coffer-unit-list-item></a>
      </template>



      <paper-fab noink="" id="add-unit" icon="add" title="add unit"></paper-fab>
      <paper-fullscreen-dialog id="new-unit">
        <h2>New Unit</h2>
        <paper-button id="create-unit" affirmative="" dialog-confirm="">create</paper-button>
        <coffer-unit-new id="new-unit-data" data="true"></coffer-unit-new>
      </paper-fullscreen-dialog>
    </ul>
  </template>

  <script>

    Polymer({

      is: 'coffer-unit-list',

      properties: {

        category: Object,

        route: Object,

        routeData: Object,

        visible: {
          type: Boolean,
          observer: '_visibleChanged'
        },

        failure: Boolean,

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 30
        }

      },

      listeners: {
        'add-unit.tap': 'onTapAddUnit',
        'new-unit.iron-overlay-closed': 'onNewUnitDialogClosed'
      },

      _visibleChanged: function(visible) {
        if (visible) {
          this.page = 1;
          this.unitListReload();
          this.fire('change-section', { title: 'unit' });
        } 
      },

      _getItemHref: function(item) {
        return item.id ? ['/unit-detail-list', item.id].join('/') : null;
      },

      _getPluralizedQuantity: function(quantity) {
        if (!quantity) {
          return '';
        }
        var pluralizedQ = quantity === 1 ? 'item' : 'items';
        return  '(' + quantity + ' ' + pluralizedQ + ')';
      },

      onTapAddUnit: function(e) {
        this.$["new-unit"].open();
      },

      createResource: function(data) {
        var ajax = this.$['get-resource'];
        var form = document.querySelector("#unitNewForm");
        var oData = new FormData(form);

        var result = {
          'name' : oData.get('name'),
          'cofferId' : data.cofferId,
          'content' : oData.get('content'),
        };

        oData.append('item', JSON.stringify(result));
        var myRequest = new XMLHttpRequest();
        myRequest.onreadystatechange = function(){
          if(myRequest.readyState == 4 && (myRequest.status == 200 || myRequest.status == 201)){
            ajax.generateRequest();
          } 
        };

        var setting = document.querySelector('#setting');
        myRequest.withCredentials = true;
        myRequest.open('post', setting.get('globals.baseUrl') + '/' + this.route.prefix,true);
        myRequest.send(oData);
      },

      unitListReload: function() {
        var ajax = this.$['get-resource'];
        ajax.generateRequest();
      },

      onNewUnitDialogClosed: function(e) {
        if(!e.detail.confirmed)
          return

        this.createResource(this.$['new-unit-data'].object);
      },

      _toArray: function(obj) {
        if(obj != null) {
          return Object.keys(obj).map(function(key) {
            return {
              value: obj[key]
            };
          });
        }
      },

      _clickUnit: function(e) {
        // alert(e.currentTarget.name);
        document.querySelector("coffer-app").route.path = '/coffer-unit-detail-list/' + e.currentTarget.name;
        document.querySelector("coffer-app").page = 'coffer-unit-detail-list';
      }

    });

  </script>

</dom-module>