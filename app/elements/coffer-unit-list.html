<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="coffer-category-data.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="coffer-unit-list-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">

<dom-module id="coffer-unit-list">

  <template>

    <style>
      :host{
      }
      paper-fab{
        @apply(--things-coffer-fab)
      }
      paper-fullscreen-dialog{
        height:80% !important;
        margin-top:9%;
        overflow:hidden;
      }
      header{
        padding:10px 5px 0 0;
        text-align:right
      }
      ul,ol{
        list-style:none;
        margin:0;
        padding:0;
      }
      a{text-decoration:none}
      li:nth-child(even){
        background-color:rgba(0,0,0,.05);
      }
    </style>

    <!--
      app-route provides the name of the category.
    -->
    <app-route
        route="[[route]]"
        pattern="/:category"
        data="{{routeData}}"></app-route>

    <!--
      coffer-category-data provides the category data for a given category name.
    -->
    <coffer-category-data
        id="categoryData"
        category-name="[[routeData.category]]"
        category="{{category}}"
        failure="{{failure}}"></coffer-category-data>

    <header>
      <!-- <h1>[[category.title]]</h1> -->
      <span>[[_getPluralizedQuantity(category.items.length)]]</span>
    </header>

    <ul hidden$="[[failure]]">
      <template is="dom-repeat" items="[[_getListItems(category.items)]]" initial-count="4">
        <li>
          <a href$="[[_getItemHref(item)]]"><coffer-unit-list-item item="[[item]]"></coffer-unit-list-item></a>
        </li>
      </template>

      <template is="dom-repeat" items="[[unit]]" as="entry">
        <li>
          <a href$="[[_getItemHref(entry)]]"><coffer-unit-list-item item="[[entry]]"></coffer-unit-list-item></a>
        </li>
        <!-- <p>[[entry]]</p> -->
      </template>

      <paper-fab noink id="add-unit" icon="add" title="add unit"></paper-fab>
      <paper-fullscreen-dialog id="new-unit">
        <h2>New Unit</h2>
        <paper-button id="create-unit" affirmative dialog-confirm>create</paper-button>
        <coffer-unit-new id="new-unit-data" groups="[[_cofferList()]]"></coffer-unit-new>
      </paper-fullscreen-dialog>
    </ul>
  </template>

  <script>

    Polymer({

      is: 'coffer-unit-list',

      properties: {

        category: Object,

        route: Object,

        routeData: Object,

        visible: Boolean,

        offline: {
          type: Boolean,
          observer: '_offlineChanged'
        },

        failure: Boolean,

        unit: Array

      },

      listeners: {
        'add-unit.tap': 'onTapAddUnit',
        'new-unit.iron-overlay-closed': 'onNewUnitDialogClosed'
      },

      observers: [
        '_categoryChanged(category, visible)'
      ],

      _getListItems: function(items) {
        // Return placeholder items when the items haven't loaded yet.
        return items || [{},{},{},{},{},{},{},{},{},{}];
      },

      _getItemHref: function(item) {
        // By returning null when `itemId` is undefined, the href attribute won't be set and
        // the link will be disabled.
        return item.name ? ['/unit-detail-list', this.category.name, item.name].join('/') : null;
      },

      _getPluralizedQuantity: function(quantity) {
        if (!quantity) {
          return '';
        }
        var pluralizedQ = quantity === 1 ? 'item' : 'items';
        return  '(' + quantity + ' ' + pluralizedQ + ')';
      },

      _categoryChanged: function(category, visible) {
        if (visible) {
          this.debounce('change-section', function() {
            // Notify the category and the page's title
            this.fire('change-section', {
              category: category.name,
              title: category.title
            });
          });
        }
      },

      _tryReconnect: function() {
        this.$.categoryData.refresh();
      },

      _offlineChanged: function(offline) {
        if (!offline) {
          this._tryReconnect();
        }
      },

      onTapAddUnit: function(e) {
        this.$["new-unit"].open();
      },

      createResource: function(data) {
        this.fire('add-unit-item', {
          name : data.name,
          title: data.name,
          category: this.category.name,
          description : data.description,
          group : data.group,
          image:"/data/images/10-24102B.jpg",
          largeImage:"/data/images/10-24102A.jpg"
        });
      },

      onNewUnitDialogClosed: function(e) {
        if(!e.detail.confirmed)
          return

        this.createResource(this.$['new-unit-data'].object);
      },

      _toArray: function(obj) {
        if(obj != null) {
          return Object.keys(obj).map(function(key) {
            return {
              value: obj[key]
            };
          });
        }
      },

      _cofferList: function() {
        var list = [{'groupTitle':'KHAKI_FIELD'},{'groupTitle':'KHAKI_AVIATION'},{'groupTitle':'JAZZMASTER'},{'groupTitle':'KHAKI_NAVY'}];

        return list;
      }

    });

  </script>

</dom-module>