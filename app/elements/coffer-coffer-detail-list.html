<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="coffer-unit-list-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">

<dom-module id="coffer-coffer-detail-list">

  <template>

    <style>
      paper-fab {
        position: fixed;
        bottom: 15px;
        right: 16px;
      }
      paper-fullscreen-dialog{
        height:80% !important;
        margin-top:9%;
        overflow:hidden;
      }

    </style>

    <!-- <app-route route="[[route]]" pattern="/:category" data="{{routeData}}"></app-route> -->

    <things-ajax id="coffer-search" method="GET" resource-action="index" resource-url="coffers" query-fields="[[cofferQueryFields]]" page="[[page]]" limit="[[limit]]" last-response="{{cofferResource}}">
    </things-ajax>

    <things-ajax id="unit-search" method="GET" resource-action="index" resource-url="units" query-fields="[[unitQueryFields]]" page="[[page]]" limit="[[limit]]" last-response="{{unitResource}}">
    </things-ajax>


    <header>
      <template is="dom-repeat" items="[[cofferResource.items]]">
        <!-- <h1>Coffer Color : [[item.coffer_color]]</h1> -->
        <h1>Coffer Title : [[item.name]]</h1>
        <h1>Unit Count : [[item.count]]</h1>
        <h1>Create Date : [[item.created_at]]</h1>
      </template>
    </header>

    <ul>
      <template is="dom-repeat" items="[[unitResource.items]]">
        <li>
          <coffer-unit-list-item item="[[item]]"></coffer-unit-list-item>
        </li>
      </template>

      <paper-fab noink="" id="add-unit" icon="add" title="add unit"></paper-fab>
      <paper-fullscreen-dialog id="new-unit">
        <h2>New Unit</h2>
        <paper-button id="create-unit" affirmative="" dialog-confirm="">create</paper-button>
        <coffer-unit-new id="new-unit-data_coffer"></coffer-unit-new>
      </paper-fullscreen-dialog>
    </ul>
  </template>

  <script>

    Polymer({

      is: 'coffer-coffer-detail-list',

      properties: {

        route: {
          type: Object,
          observer: 'routeChange'
        },

        routeData: Object,

        visible: {
          type: Boolean,
          observer: '_visibleChanged'
        },

        failure: Boolean,

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 30
        }

      },

      listeners: {
        'add-unit.tap': 'onTapAddUnit',
        'new-unit.iron-overlay-closed': 'onNewUnitDialogClosed'
      },

      routeChange: function(route) {
        // alert('route.path : ' + route.path);
        // alert('route.prefix : ' + route.prefix);
        if(route.prefix == '/coffer-unit-detail') {
          var cofferId = route.path.substr(1);

          if(cofferId != null && cofferId != "") {
            this.unitQueryFields = [ {
              name: 'coffer_id',
              operator: 'eq',
              value: cofferId
            } ];

            this.unitListReload();

            this.cofferQueryFields = [ {
              name: 'id',
              operator: 'eq',
              value: cofferId
            } ];

            this.cofferListReload();
          }
        }
      },

      _visibleChanged: function(visible) {
        var test = this.route.path.split('/');
        this.route.path = test[2];
        this.route.prefix = test[1];

        if (visible) {
          this.page = 1;
          // this.unitListReload();
          // this.cofferListReload();
          // this.fire('change-section', { title: this.routeData.category });
          
          if(this.route.prefix == 'coffer-coffer-detail-list') {
            var cofferId = this.route.path;

            if(cofferId != null && cofferId != "") {
              this.unitQueryFields = [ {
                name: 'coffer_id',
                operator: 'eq',
                value: cofferId
              } ];

              this.unitListReload();

              this.cofferQueryFields = [ {
                name: 'id',
                operator: 'eq',
                value: cofferId
              } ];

              this.cofferListReload();
            }
          } 
          
        } 
      },

      onTapAddUnit: function(e) {
        this.$["new-unit"].open();
      },

      createResource: function(data) {
        var ajax = this.$['unit-search'];
        var form = document.querySelector("#unitNewForm");
        var oData = new FormData(form);

        var result = {
          'name' : oData.get('name'),
          'cofferId' : data.cofferId,
          'content' : oData.get('content'),
        };

        oData.append('item', JSON.stringify(result));
        var myRequest = new XMLHttpRequest();
        myRequest.onreadystatechange = function(){
          if(myRequest.readyState == 4 && (myRequest.status == 200 || myRequest.status == 201)){
            ajax.generateRequest();
          } 
        };

        var setting = document.querySelector('#setting');
        myRequest.withCredentials = true;
        myRequest.open('post', setting.get('globals.baseUrl') + '/units',true);
        myRequest.send(oData);
      },

      onNewUnitDialogClosed: function(e) {
        if(!e.detail.confirmed)
          return

        this.createResource(this.$['new-unit-data_coffer'].object);
      },

      unitListReload: function() {
        var ajax = this.$['unit-search'];
        ajax.generateRequest();
      },

      cofferListReload: function() {
        var ajax = this.$['coffer-search'];
        ajax.generateRequest();
      }

    });

  </script>

</dom-module>