<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">

<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">

<dom-module id="coffer-unit-detail-list">

  <template>

    <style>

      :host {
        display: block;
      }
      .detail {
        margin:0;
        width: 100%;
        transition: opacity 0.4s;
        opacity: 1;
      }
      #content {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
      }
      paper-card::shadow iron-image{
        width:initial !important;
        max-height:450px;
        margin-top:65px;
      }
      paper-card{
        @apply(--things-coffer-detail-card);
      }
      paper-card::shadow .title-text{
        top:10px;
        left:15px;
        bottom:initial !important;
        padding:0 !important;
        color:var(--app-primary-color) !important;
        font-size:20px !important;
        font-weight:bold !important;
      }
      paper-fab{
        @apply(--things-coffer-fab)
      }
      paper-fullscreen-dialog{
        height:80% !important;
        margin-top:9%;
        overflow:hidden;
      }
      .rate-info{
        @apply(--things-coffer-desc);
        position:absolute;
        top:40px;
        left:15px;
      }
      .rate-info iron-icon{
        @apply(--things-coffer-info-icon);
      }
      .card-actions{
        background-color:#f6f6f6;
        text-align:left;
      }
      .card-actions paper-icon-button{
        position:absolute;
        right:0;
        margin-top:-7px;
      }
      .card-actions h2{
        margin:0;
        padding:5px 0 0 0;
        font-size:14px;
        color:var(--app-primary-text-color);
      }
      .card-actions p{
        color:var(--app-primary-text-color);
        opacity:.7;
        margin:0 0 0px 0;
        font-size:12px;
      }
      ul{
        list-style: none;
        background-color:#f6f6f6;
        margin:0;
        padding:5px 0 0 0;
      }
      .timeline-item{
        background:url(/images/bg-timeline.png) 17px 0 repeat-y #f6f6f6;
        border-bottom:1px solid #ddd;
        overflow:hidden;
        clear:both;
        padding:9px 0 8px 0;
      }
      .timeline-item:nth-child(even){
        background-color:rgba(255,255,255,.8);
      }
      .timeline-item .timedot{
        float:left;
        width:70px;
      }
      .timedot{
        padding-left:30px;
        font-size:11px;
        color:var(--app-primary-text-color);
      }
      .timedot span{
        width:6px;height:6px;
        margin:10px 5px 0 -18px;
        background-color:#fff;
        display:block;
        position:absolute;
        border-radius:7px;
        border:solid 3px #acacac;
      }
      .timeline-item .content{

        font-size:15px;
        color:var(--app-primary-text-color);
        line-height:1.3
      }
      .timeline-item .content strong{
        display:block;
      }
      .discard .timedot span{border-color:var(--app-primary-color);}
      .discard .content strong{color:var(--app-primary-color);}
      .create .timedot span{border-color:#87c833;}
      .create .content strong{color:#87c833;}
      .timeline-item .content div{
        float:right;
        margin:3px 7px 0 0;
      }
      .timeline-item .edit{
        background:url(/images/icon-more.png) 50% -200px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
      .timeline-item .delete{
        background:url(/images/icon-more.png) 50% -250px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
    </style>

    <app-route
        route="[[route]]"
        pattern="/:category"
        data="{{routeData}}"></app-route>

    <things-ajax
      id="unit-search"
      method="GET"
      resource-url="units/[[routeData.category]]"
      last-response="{{unitResource}}">
    </things-ajax>

    <things-ajax
      id="timeline-search"
      method="GET"
      resource-action="index"
      resource-url="time_lines"
      query-fields="[[timelineQueryFields]]"
      page="[[page]]"
      limit="[[limit]]"
      last-response="{{timelineResource}}">
    </things-ajax>

    <things-ajax
      id="create-timeline-ajax"
      resource-action="create"
      resource-url="time_lines">
    </things-ajax>

    <things-ajax
      id="delete-timeline-ajax"
      resource-action="delete"
      resource-url="time_lines/[[timelineId]]">
    </things-ajax>

    <div id="content">
      <div class="detail">
        <template is="dom-if" if="{{_showUnit(unitResource)}}">
          <paper-card heading="[[unitResource.name]]" image="[[_imageSrc(unitResource.thumbnail_id)]]" class="white" elevation="0">
            <div class="rate-info">
             <iron-icon icon="icons:assignment"></iron-icon>[[unitResource.coffer_id]]
             <iron-icon icon="icons:alarm-on"></iron-icon><span>12</span>
            </div>
            <div class="card-actions">
              <paper-icon-button icon="hardware:keyboard-arrow-up" title="more info" on-tap="_toggle">
              </paper-icon-button>
              <iron-collapse id="moreInfo" style="width:100%;">
                <div class="description">
                  <h2>Description</h2>
                  <p>[[unitResource.content]]</p>
                  <!-- <p id="desc"></p> -->
                </div>
              </iron-collapse>
            </div>
          </paper-card>
        </template>
        
        <ul>
        <template is="dom-repeat" items="[[timelineResource.items]]" as="timeline">
          <li class="timeline-item"> <!--type : create-생성, discard-폐기, 없음-기본-->
            <div class="timedot">
              <span></span>
              {{timeline.updated_at}}
            </div>
            <div class="content">
              <strong>{{timeline.name}}</strong>
              {{timeline.content}}
              <div>
                <paper-button raised class="edit" on-click ="_edit"></paper-button>
                <paper-button raised name="[[timeline.id]]" class="delete" on-click ="_delete"></paper-button>
              </div>
            </div>
          </li>
        </template>
        </ul>
      </div>

      <paper-fab noink id="add-timeline" icon="add" title="add timeline"></paper-fab>
      <paper-fullscreen-dialog id="new-timeline">
        <h2>New Timeline</h2>
        <paper-button id="create-timeline" affirmative dialog-confirm>create</paper-button>
        <coffer-unit-timeline-new id="new-timeline-data"></coffer-unit-timeline-new>
      </paper-fullscreen-dialog>
    </div>

  </template>

  <script>

    Polymer({

      is: 'coffer-unit-detail-list',

      properties: {

        route: {
          type: Object,
          observer: 'routeChange'
        },

        routeData: Object,

        visible: {
          type: Boolean,
          observer: '_visibleChanged'
        },

        failure: Boolean,

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 30
        }

      },

      listeners: {
        'add-timeline.tap': 'onTapAddTimeline',
        'new-timeline.iron-overlay-closed': 'onNewTimelineDialogClosed',
        'create-timeline-ajax.things-ajax-response' : '_handleSaveSuccess',
        'create-timeline-ajax.things-ajax-error' : '_handleSaveFailure',
        'delete-timeline-ajax.things-ajax-response' : '_handleSaveSuccess',
        'delete-timeline-ajax.things-ajax-error' : '_handleSaveFailure'
      },

      routeChange: function(route) {
        if(route.prefix == '/unit-detail-list') {
          var unitId = route.path.substr(1);

          if(unitId != null && unitId != "") {
            this.timelineQueryFields = [ {
              name: 'unit_id',
              operator: 'eq',
              value: unitId
            } ];

            var ajax = this.$['timeline-search'];
            ajax.generateRequest();

            this.$['unit-search'].generateRequest();
          }
        }
      },

      _visibleChanged: function(visible) {
        if (visible) {
          this.page = 1;
          this.fire('change-section', { title: this.routeData.category });
        } 
      },

      _showUnit: function(item) {
        return item != null;
      },

      _toggle: function(e) {
        var moreInfo = e.currentTarget.parentElement.querySelector('iron-collapse');
        var iconButton = Polymer.dom(event).localTarget;
        iconButton.icon = moreInfo.opened ? 'hardware:keyboard-arrow-up'
                                          : 'hardware:keyboard-arrow-down';
        moreInfo.toggle();
      },

      onTapAddTimeline: function(e) {
        this.$["new-timeline"].open();
      },

      createResource: function(data) {
        var row = {
          'name' : data.name,
          'unit_id' : this.routeData.category,
          'content' : data.content
        };

        var ajax = this.$['create-timeline-ajax'];
        ajax.body = row;
        ajax.generateRequest();
      },

      onNewTimelineDialogClosed: function(e) {
        if(!e.detail.confirmed)
          return

        this.createResource(this.$['new-timeline-data'].object);
      },

      _getItemHref: function(testArr, item) {
        return item.name ? ['/unit-detail', item.category, item.name, testArr.value.testName].join('/') : null;
      },

      _imageSrc: function(thumbnail) {
        if(thumbnail != null) {
          var setting = document.querySelector('#setting');
          return setting.get('globals.baseUrl') + "/download/" + thumbnail
        }
      },

      /**
       * 저장 성공시 액션
       *
       * @param {Object} event
       */
      _handleSaveSuccess: function(event) {
        this.timelineListReload();
      },

      /**
       * 저장 실패시 액션
       *
       * @param {Object} event
       */
      _handleSaveFailure: function(event) {
        alert('fail');
      },

      timelineListReload: function() {
        var ajax = this.$['timeline-search'];
        ajax.generateRequest();
      },

      _edit: function(timeline) {
        console.log(timeline.target.data);
      },

      _delete: function(timeline) {
        var ajax = this.$['delete-timeline-ajax'];
        this.timelineId = timeline.target.name;
        ajax.generateRequest();

        // this.timelineListReload();
      }

    });

  </script>

</dom-module>
