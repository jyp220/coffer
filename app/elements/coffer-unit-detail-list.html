<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">

<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/fullscreen-api/fullscreen-api.html">

<dom-module id="coffer-unit-detail-list">

  <template>

    <style>
      :host {
        display: block;
      }
      .detail {
        margin:0;
        width: 100%;
        transition: opacity 0.4s;
        opacity: 1;
      }
      #content {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
      }
      paper-card iron-image{
        @apply(--things-coffer-detail-img-container)
      }
      paper-card iron-image::shadow img{
        max-width:100%
      }
      paper-card{
        @apply(--things-coffer-detail-card);
      }
      paper-card::shadow .title-text{
        @apply(--things-coffer-detail-title);
      }
      paper-fab{
        @apply(--things-coffer-fab)
      }
      .rate-info{
        @apply(--things-coffer-desc);
        position:absolute;
        top:40px;
        left:15px;
      }
      .rate-info iron-icon{
        @apply(--things-coffer-info-icon);
      }
      .card-actions{
        background-color:rgba(221,212,196,.7);
        text-align:left;
      }
      .card-actions paper-icon-button{
        @apply(--things-coffer-detail-cardaction-btn)
      }
      .card-actions h2{
        @apply(--things-coffer-detail-cardaction-title)
      }
      .card-actions p{
        @apply(--things-coffer-detail-cardaction-text)
      }
      ul{
        list-style: none;
        background-color:#f6f6f6;
        margin:0;
        padding:5px 0 0 0;
      }
      .timeline-item{
        background:url("../images/bg-timeline.png") 17px 0 repeat-y #f6f6f6;
        @apply(--things-coffer-detail-tileline-item)
      }
      .timeline-item:nth-child(even){
        background-color:rgba(255,255,255,.8);
      }
      .timeline-item .timedot{
        @apply(--things-coffer-detail-tileline-dot-container);
      }
      .timedot span{
        @apply(--things-coffer-detail-tileline-dot);
      }
      .timeline-item .content{
        font-size:15px;
        color:var(--app-primary-text-color);
        line-height:1.3
      }
      .timeline-item .content strong{
        display:block;
      }
      .timeline-item .content div{
        float:right;
        margin:3px 7px 0 0;
      }
      .timeline-item .edit{
        background:url("../images/icon-more.png") 50% -200px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
      .timeline-item .delete{
        background:url("../images/icon-more.png") 50% -250px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
      .cofferlist{
        background-color:rgba(221,212,196,.7);
        padding:0 10px 5px 15px;
      }
      .cofferlist label{
        @apply(--things-coffer-detail-cofferlist-label);
      }
      .cofferlist a{
        @apply(--things-coffer-detail-cofferlist-link)
      }
      .cofferlist iron-icon{
        @apply(--things-coffer-info-icon);
        opacity:.5
      }
    </style>


    <things-ajax id="coffer-search" method="GET" resource-action="index" resource-url="coffers/coffer_list" last-response="{{cofferResource}}">
    </things-ajax>

    <things-ajax id="timeline-search" method="GET" resource-action="index" resource-url="time_lines" query-fields="[[timelineQueryFields]]" page="[[page]]" limit="[[limit]]" last-response="{{timelineResource}}">
    </things-ajax>
    <things-ajax id="unit-search" method="GET" resource-url="units/[[unitItemId]]" last-response="{{unitResource}}">
    </things-ajax>

    <things-ajax id="timeline-item-search" method="GET" resource-action="index" resource-url="time_lines/[[timelineItemId]]" last-response="{{timelineItemResource}}">
    </things-ajax>

    <things-ajax id="create-timeline-ajax" resource-action="create" resource-url="time_lines">
    </things-ajax>

    <things-ajax id="delete-timeline-ajax" resource-action="delete" resource-url="time_lines/[[deleteTimelineId]]">
    </things-ajax>

    <things-ajax id="update-timeline-ajax" resource-action="update" resource-url="time_lines/[[timelineItemId]]">
    </things-ajax>

    <fullscreen-api id="fsapi"></fullscreen-api>

    <div id="content">
      <div class="detail">
        <paper-card heading="[[unitResource.name]]" class="white" elevation="0">
          <iron-swipeable-pages selected="0">
            <template is="dom-repeat" items="[[_imageSrc(unitResource.thumbnail_id)]]" as="unitSrc">
              <iron-image id="example-full-width" src="[[unitSrc.src]]"></iron-image>
            </template>
          </iron-swipeable-pages>

          <div class="rate-info">
           <iron-icon icon="icons:assignment"></iron-icon>[[unitResource.coffer.name]]
           <iron-icon icon="icons:alarm-on"></iron-icon><span>[[_setDateTime(unitResource.updated_at)]]</span>
           <iron-icon id="unitFavorite" icon="icons:star-border" on-click="_onFavorite"></iron-icon>
          </div>
          <div class="card-actions">
            <paper-icon-button icon="hardware:keyboard-arrow-up" title="more info" on-tap="_toggle">
            </paper-icon-button>
            <iron-collapse id="moreInfo" style="width:100%;">
              <div class="description">
                <h2>Description</h2>
                <p>[[unitResource.content]]</p>

              </div>
            </iron-collapse>
          </div>
        </paper-card>

        <div class="cofferlist">
          <label>[[unitResource.creator.name]]`s Coffer List</label>
          <template is="dom-repeat" items="[[cofferResource.items]]" as="coffer">
            <iron-icon icon="icons:assignment"></iron-icon><a href="{{baseUrl}}/coffer-detail-list/[[coffer.id]]" name="[[coffer.id]]">[[coffer.name]] </a>
          </template>
        </div>

        <ul>
        <template is="dom-repeat" items="[[timelineResource.items]]" as="timeline">
          <li class$="{{timelineItem(timeline)}}" name="[[timeline.id]]" on-click="_edit">
          <!-- <li class="timeline-item create">  -->
            <div class="timedot">
              <span></span>
              [[_setDateTime(timeline.updated_at)]]
            </div>

            <iron-swipeable-pages selected="0">
              <template is="dom-repeat" items="[[_imageSrc(timeline.image_id)]]" as="timelineSrc">
                <iron-image id="example-full-width" src="[[timelineSrc.src]]"></iron-image>
              </template>
            </iron-swipeable-pages>

            <div class="content">
              <strong>{{timeline.name}}</strong>
              {{timeline.content}}
            </div>
          </li>
        </template>
        </ul>
      </div>

      <paper-fab noink="" id="add-timeline" icon="add" title="add timeline"></paper-fab>
      <paper-dialog id="new-timeline" modal>
        <h2>New Timeline</h2>
        <coffer-unit-timeline-new id="new-timeline-data" data="coffer-timeline-create" timeline-thumbnail="[[timelineThumbnail]]"></coffer-unit-timeline-new>
      </paper-dialog>

      <paper-dialog id="update-timeline" modal>
        <h2>Update Timeline</h2>
        <coffer-unit-timeline-update id="update-timeline-data" data="coffer-timeline-update" timeline-id="[[timelineId]]" name="[[timelineName]]" content="[[timelineContent]]" timeline-thumbnail="[[timelineUpdateThumbnail]]"></coffer-unit-timeline-update>
      </paper-dialog>
    </div>

  </template>

  <script>

    Polymer({

      is: 'coffer-unit-detail-list',

      properties: {

        visible: Boolean,

        defaultPage: {
          type: Number,
          value: 0
        },

        defaultLimit: {
          type: Number,
          value: 0
        },

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 30
        },

        timelineCnt: {
          type: Number,
          value: 1
        }

      },

      observers: [
        '_routeChanged(params.id, visible)'
      ],

      listeners: {
        'add-timeline.tap': 'onTapAddTimeline',
        'create-timeline-ajax.things-ajax-response' : '_handleSaveSuccess',
        'create-timeline-ajax.things-ajax-error' : '_handleSaveFailure',
        'delete-timeline-ajax.things-ajax-response' : '_handleSaveSuccess',
        'delete-timeline-ajax.things-ajax-error' : '_handleSaveFailure',
        'timeline-item-search.things-ajax-response' : '_handleSearchSuccess',
        'timeline-item-search.things-ajax-error' : '_handleSearchFailure',
        'update-timeline-ajax.things-ajax-response' : '_handleSaveSuccess',
        'update-timeline-ajax.things-ajax-error' : '_handleSaveFailure',
        'coffer-timeline-create-success' : '_onSuccessTimeline',
        'coffer-timeline-create-close' : '_onCloseTimeline',
        'coffer-timeline-update-success' : '_onSuccessTimeline',
        'coffer-timeline-update-close' : '_onCloseTimeline'
      },

      behaviors: [
        Things.GlobalBehavior
      ],

      _onFavorite: function(e) {
        if (e.currentTarget.hasAttribute('active')) {
          e.currentTarget.removeAttribute('active');
          e.currentTarget.icon = 'icons:star-border'
        }
        else {
          e.currentTarget.setAttribute('active', '');
          e.currentTarget.icon = 'icons:star'
        }
        alert(e.currentTarget.hasAttribute('active'));
      },

      _routeChanged: function(id, visible) {
        if (visible) {
          this.$.unitFavorite.setAttribute('active', '');
          this.$.unitFavorite.icon = 'icons:star';

          this.timelineCnt = 1;
          this.page = 1;

          var unitId = id;
          this.unitItemId = unitId;

          if(unitId != null && unitId != "") {
            this.timelineQueryFields = [ {
              name: 'unit_id',
              operator: 'eq',
              value: this.unitItemId
            } ];

            var ajax = this.$['timeline-search'];
            ajax.generateRequest();

            this.$['unit-search'].generateRequest();
            this.$['coffer-search'].generateRequest();
          }
        }
      },

      _toggle: function(e) {
        var moreInfo = e.currentTarget.parentElement.querySelector('iron-collapse');
        var iconButton = Polymer.dom(event).localTarget;
        iconButton.icon = moreInfo.opened ? 'hardware:keyboard-arrow-up'
                                          : 'hardware:keyboard-arrow-down';
        moreInfo.toggle();
      },

      onTapAddTimeline: function(e) {
        this.timelineThumbnail = '';
        this.$["new-timeline"].open();
      },

      _imageSrc: function(thumbnail) {
        if(thumbnail != null) {
          var thumbnailIds = thumbnail.split(',');
          var arr = [];


          for(var i = 0 ; i < thumbnailIds.length ; i++) {
            var obj = {'src' : this.get('globals.baseUrl') + "/download/" + thumbnailIds[i]};
            arr.push(obj);
          }

          return arr;
        }
      },

      _handleSaveSuccess: function(event) {
        this.timelineListReload();
      },

      _handleSaveFailure: function(event) {
        alert('fail');
      },

      timelineListReload: function() {
        var ajax = this.$['timeline-search'];
        ajax.generateRequest();
      },

      _delete: function(timeline) {
        var ajax = this.$['delete-timeline-ajax'];
        this.deleteTimelineId = timeline.target.name;
        ajax.generateRequest();
      },

      _handleSearchSuccess: function(event) {
        this.timelineName = event.detail.name;
        this.timelineContent = event.detail.content;
        this.timelineUpdateThumbnail = event.detail.image_id;
        this.timelineId = event.detail.id;

        this.$["update-timeline"].open();
      },

      _handleSearchFailure: function(event) {
        alert('fail');
      },

      timelineItem: function(timeline) {
        var result = 'timeline-item';
        if(timeline.terminate_at != null) {
          result = 'timeline-item discard';
        } else if(this.timelineCnt == this.timelineResource.items.length) {
          result = 'timeline-item create';
        }

        this.timelineCnt++;
        return result;
      },

      clickOnImage: function(e) {
        var thumbnailIds = this.unitResource.thumbnail_id.split(',');
        this.unitThumbnail = setting.get('globals.baseUrl') + "/download/" + thumbnailIds[0];
        this.$['unit-image-viewer'].open();

        // this.toggleFullscreen(event.target);
      },

      toggleFullscreen: function(element) {
        var fsapi = document.querySelector('#fsapi');
        fsapi.target = element;
        fsapi.toggleFullscreen();
      },

      _onSuccessTimeline: function(event) {
        this.timelineListReload();
        if(event.target.id === 'new-timeline-data') {
          this.$['new-timeline'].close();
        } else {
          this.$['update-timeline'].close();
        }
      },

      _onCloseTimeline: function(event) {
        if(event.target.id === 'new-timeline-data') {
          this.$['new-timeline'].close();
        } else {
          this.timelineListReload();
          this.$['update-timeline'].close();
        }
      },

      _setDateTime: function(updatedAt) {
        return updatedAt.substring(0, 16);
      },

      _edit: function(timeline) {
        var ajax = this.$['timeline-item-search'];
        this.timelineItemId = timeline.currentTarget.name;
        ajax.generateRequest();
      }

    });

  </script>

</dom-module>
