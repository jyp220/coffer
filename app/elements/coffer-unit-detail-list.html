<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">

<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/fullscreen-api/fullscreen-api.html">

<dom-module id="coffer-unit-detail-list">

  <template>

    <style>

      :host {
        display: block;
      }
      .detail {
        margin:0;
        width: 100%;
        transition: opacity 0.4s;
        opacity: 1;
      }
      #content {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
      }
      paper-card::shadow iron-image{
        width:initial !important;
        max-height:450px;
        margin-top:65px;
      }
      paper-card{
        @apply(--things-coffer-detail-card);
      }
      paper-card::shadow .title-text{
        top:10px;
        left:15px;
        bottom:initial !important;
        padding:0 !important;
        color:var(--app-primary-color) !important;
        font-size:20px !important;
        font-weight:bold !important;
      }
      paper-fab{
        @apply(--things-coffer-fab)
      }
      paper-fullscreen-dialog{
        height:80% !important;
        margin-top:9%;
        overflow:hidden;
      }
      .rate-info{
        @apply(--things-coffer-desc);
        position:absolute;
        top:40px;
        left:15px;
      }
      .rate-info iron-icon{
        @apply(--things-coffer-info-icon);
      }
      .card-actions{
        background-color:#f6f6f6;
        text-align:left;
      }
      .card-actions paper-icon-button{
        position:absolute;
        right:0;
        margin-top:-7px;
      }
      .card-actions h2{
        margin:0;
        padding:5px 0 0 0;
        font-size:14px;
        color:var(--app-primary-text-color);
      }
      .card-actions p{
        color:var(--app-primary-text-color);
        opacity:.7;
        margin:0 0 0px 0;
        font-size:12px;
      }
      ul{
        list-style: none;
        background-color:#f6f6f6;
        margin:0;
        padding:5px 0 0 0;
      }
      .timeline-item{
        background:url("../images/bg-timeline.png") 17px 0 repeat-y #f6f6f6;
        border-bottom:1px solid #ddd;
        overflow:hidden;
        clear:both;
        padding:9px 0 8px 0;
      }
      .timeline-item:nth-child(even){
        background-color:rgba(255,255,255,.8);
      }
      .timeline-item .timedot{
        float:left;
        width:70px;
      }
      .timedot{
        padding-left:30px;
        font-size:11px;
        color:var(--app-primary-text-color);
      }
      .timedot span{
        width:6px;height:6px;
        margin:10px 5px 0 -18px;
        background-color:#fff;
        display:block;
        position:absolute;
        border-radius:7px;
        border:solid 3px #acacac;
      }
      .timeline-item .content{

        font-size:15px;
        color:var(--app-primary-text-color);
        line-height:1.3
      }
      .timeline-item .content strong{
        display:block;
      }
      .discard .timedot span{border-color:var(--app-primary-color);}
      .discard .content strong{color:var(--app-primary-color);}
      .create .timedot span{border-color:#87c833;}
      .create .content strong{color:#87c833;}
      .timeline-item .content div{
        float:right;
        margin:3px 7px 0 0;
      }
      .timeline-item .edit{
        background:url("../images/icon-more.png") 50% -200px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
      .timeline-item .delete{
        background:url("../images/icon-more.png") 50% -250px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
    </style>


    <things-ajax id="coffer-search" method="GET" resource-action="index" resource-url="coffers/coffer_list" last-response="{{cofferResource}}">
    </things-ajax>

    <things-ajax id="timeline-search" method="GET" resource-action="index" resource-url="time_lines" query-fields="[[timelineQueryFields]]" page="[[page]]" limit="[[limit]]" last-response="{{timelineResource}}">
    </things-ajax>
    <things-ajax id="unit-search" method="GET" resource-url="units/[[unitItemId]]" last-response="{{unitResource}}">
    </things-ajax>

    <things-ajax id="timeline-item-search" method="GET" resource-action="index" resource-url="time_lines/[[timelineItemId]]" last-response="{{timelineItemResource}}">
    </things-ajax>

    <things-ajax id="create-timeline-ajax" resource-action="create" resource-url="time_lines">
    </things-ajax>

    <things-ajax id="delete-timeline-ajax" resource-action="delete" resource-url="time_lines/[[deleteTimelineId]]">
    </things-ajax>

    <things-ajax id="update-timeline-ajax" resource-action="update" resource-url="time_lines/[[timelineItemId]]">
    </things-ajax>

    <fullscreen-api id="fsapi"></fullscreen-api>

    <div id="content">
      <div class="detail">
        <paper-card heading="[[unitResource.name]]" class="white" elevation="0">
          <iron-swipeable-pages selected="0">
            <template is="dom-repeat" items="[[_imageSrc(unitResource.thumbnail_id)]]" as="unitSrc">
              <iron-image id="example-full-width" src="[[unitSrc.src]]"></iron-image>
            </template>
          </iron-swipeable-pages>
          
          <div class="rate-info">
           <iron-icon icon="icons:assignment"></iron-icon>[[unitResource.coffer.name]]
           <iron-icon icon="icons:alarm-on"></iron-icon><span>[[unitResource.updated_at]]</span>
           <favorite-star on-click="_onFavorite"></favorite-star>
          </div>
          <div class="card-actions">
            <paper-icon-button icon="hardware:keyboard-arrow-up" title="more info" on-tap="_toggle">
            </paper-icon-button>
            <iron-collapse id="moreInfo" style="width:100%;">
              <div class="description">
                <h2>Description</h2>
                <p>[[unitResource.content]]</p>
                
              </div>
            </iron-collapse>
          </div>
        </paper-card>

        <p>[[unitResource.creator.name]]`s Coffer List</p>
        <template is="dom-repeat" items="[[cofferResource.items]]" as="coffer">
          <a href="{{baseUrl}}/coffer-detail-list/[[coffer.id]]" name="[[coffer.id]]">[[coffer.name]] / </a>
        </template>
        
        <ul>
        <template is="dom-repeat" items="[[timelineResource.items]]" as="timeline">
          <li class$="{{timelineItem(timeline)}}"> 
          <!-- <li class="timeline-item create">  -->
            <div class="timedot">
              <span></span>
              {{timeline.updated_at}}
            </div>

            <iron-swipeable-pages selected="0">
              <template is="dom-repeat" items="[[_imageSrc(timeline.image_id)]]" as="timelineSrc">
                <iron-image id="example-full-width" width="200" src="[[timelineSrc.src]]"></iron-image>
              </template>
            </iron-swipeable-pages>

            <div class="content">
              <strong>{{timeline.name}}</strong>
              {{timeline.content}}
              <div>
                <paper-button raised="" name="[[timeline.id]]" class="edit" on-click="_edit"></paper-button>
                <paper-button raised="" name="[[timeline.id]]" class="delete" on-click="_delete"></paper-button>
              </div>
            </div>
          </li>
        </template>
        </ul>
      </div>

      <paper-fab noink="" id="add-timeline" icon="add" title="add timeline"></paper-fab>
      <paper-dialog id="new-timeline" modal>
        <h2>New Timeline</h2>
        <paper-button id="create-timeline" affirmative="" dialog-confirm="">create</paper-button>
        <coffer-unit-timeline-new id="new-timeline-data" data="coffer-timeline-create"></coffer-unit-timeline-new>
      </paper-fullscreen-dialog>

      <paper-fullscreen-dialog id="update-timeline">
        <h2>Update Timeline</h2>
        <paper-button id="btn-update-timeline" affirmative="" dialog-confirm="">update</paper-button>
        <coffer-unit-timeline-update id="update-timeline-data" name="[[timelineName]]", content="[[timelineContent]]"></coffer-unit-timeline-update>
      </paper-fullscreen-dialog>

      <paper-fullscreen-dialog id="unit-image-viewer">
        <paper-button id="btn-unit-image-viewer" affirmative="" dialog-confirm=""></paper-button>
        <coffer-image-viewer unit-thumbnail="[[unitThumbnail]]"></coffer-image-viewer>
      </paper-fullscreen-dialog>
    </div>

  </template>

  <script>

    Polymer({

      is: 'coffer-unit-detail-list',

      properties: {

        visible: Boolean,

        defaultPage: {
          type: Number,
          value: 0
        },

        defaultLimit: {
          type: Number,
          value: 0
        },

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 30
        },

        timelineCnt: {
          type: Number,
          value: 1
        }

      },

      observers: [
        '_routeChanged(params.id, visible)'
      ],

      listeners: {
        'add-timeline.tap': 'onTapAddTimeline',
        'update-timeline.iron-overlay-closed': 'onUpdateTimelineDialogClosed',
        'create-timeline-ajax.things-ajax-response' : '_handleSaveSuccess',
        'create-timeline-ajax.things-ajax-error' : '_handleSaveFailure',
        'delete-timeline-ajax.things-ajax-response' : '_handleSaveSuccess',
        'delete-timeline-ajax.things-ajax-error' : '_handleSaveFailure',
        'timeline-item-search.things-ajax-response' : '_handleSearchSuccess',
        'timeline-item-search.things-ajax-error' : '_handleSearchFailure',
        'update-timeline-ajax.things-ajax-response' : '_handleSaveSuccess',
        'update-timeline-ajax.things-ajax-error' : '_handleSaveFailure',
        'coffer-timeline-create-success' : '_onSuccessTimeline',
        'coffer-timeline-create-close' : '_onCloseTimeline'
      },

      _onFavorite: function(e) {
        alert(e.currentTarget.hasAttribute('active'));
      },

      _routeChanged: function(id, visible) {
        if (visible) {
          this.timelineCnt = 1;
          this.page = 1;

          var unitId = id;
          this.unitItemId = unitId;

          if(unitId != null && unitId != "") {
            this.timelineQueryFields = [ {
              name: 'unit_id',
              operator: 'eq',
              value: this.unitItemId
            } ];

            var ajax = this.$['timeline-search'];
            ajax.generateRequest();

            this.$['unit-search'].generateRequest();
            this.$['coffer-search'].generateRequest();
          }
        } 
      },

      _showUnit: function(item) {
        return true;
      },

      _toggle: function(e) {
        var moreInfo = e.currentTarget.parentElement.querySelector('iron-collapse');
        var iconButton = Polymer.dom(event).localTarget;
        iconButton.icon = moreInfo.opened ? 'hardware:keyboard-arrow-up'
                                          : 'hardware:keyboard-arrow-down';
        moreInfo.toggle();
      },

      onTapAddTimeline: function(e) {
        this.$["new-timeline"].open();
      },

      createResource: function(data, type) {
        if(type == 'create') {
          var row = {
            'name' : data.name,
            'unit_id' : app.params.id,
            'content' : data.content
          };

          var ajax = this.$['create-timeline-ajax'];
          ajax.body = row;
          ajax.generateRequest();
        } else if(type == 'update') {
          var row = {
            'id' : this.timelineItemId,
            'name' : data.name,
            'unit_id' : app.params.id,
            'content' : data.content
          };

          var ajax = this.$['update-timeline-ajax'];
          ajax.body = row;
          ajax.generateRequest();
        }
      },

      onUpdateTimelineDialogClosed: function(e) {
        if(!e.detail.confirmed)
          return

        this.createResource(this.$['update-timeline-data'].object, 'update');
      },

      _imageSrc: function(thumbnail) {
        if(thumbnail != null) {
          var thumbnailIds = thumbnail.split(',');
          var setting = document.querySelector('#setting');
          var arr = [];


          for(var i = 0 ; i < thumbnailIds.length ; i++) {
            var obj = {'src' : setting.get('globals.baseUrl') + "/download/" + thumbnailIds[i]};
            arr.push(obj);
          }

          return arr;
        }
      },

      /**
       * 저장 성공시 액션
       *
       * @param {Object} event
       */
      _handleSaveSuccess: function(event) {
        this.timelineListReload();
      },

      /**
       * 저장 실패시 액션
       *
       * @param {Object} event
       */
      _handleSaveFailure: function(event) {
        alert('fail');
      },

      timelineListReload: function() {
        var ajax = this.$['timeline-search'];
        ajax.generateRequest();
      },

      _edit: function(timeline) {
        var ajax = this.$['timeline-item-search'];
        this.timelineItemId = timeline.target.name;
        ajax.generateRequest();
      },

      _delete: function(timeline) {
        var ajax = this.$['delete-timeline-ajax'];
        this.deleteTimelineId = timeline.target.name;
        ajax.generateRequest();

        // this.timelineListReload();
      },

      _handleSearchSuccess: function(event) {
        this.timelineName = event.detail.name;
        this.timelineContent = event.detail.content;
        this.$['update-timeline'].toggle();
      },

      _handleSearchFailure: function(event) {
        alert('fail');
      },

      timelineItem: function(timeline) {
        var result = 'timeline-item';
        if(timeline.terminate_at != null) {
          result = 'timeline-item discard';
        } else if(this.timelineCnt == this.timelineResource.items.length) {
          result = 'timeline-item create';
        }

        this.timelineCnt++;
        return result;
      },

      clickOnImage: function(e) {
        var thumbnailIds = this.unitResource.thumbnail_id.split(',');
        this.unitThumbnail = setting.get('globals.baseUrl') + "/download/" + thumbnailIds[0];
        this.$['unit-image-viewer'].open();
        
        // this.toggleFullscreen(event.target);
      },

      toggleFullscreen: function(element) {
        var fsapi = document.querySelector('#fsapi');
        fsapi.target = element;
        fsapi.toggleFullscreen();
      },

      _qrData: function(unitItemId) {
        return "http://192.168.35.96:5000/#!/unit-detail-list/" + unitItemId;
      },

      _onSuccessTimeline: function(event) {
        this.timelineListReload();
        this.$['new-timeline'].close();
      },

      _onCloseTimeline: function(event) {
        this.$['new-timeline'].close();
      }

    });

  </script>

</dom-module>
