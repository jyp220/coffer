<link rel="import" href="coffer-category-data.html">
<link rel="import" href="coffer-unit-localstorage-data.html">
<link rel="import" href="coffer-timeline-localstorage-data.html">

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">

<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">

<dom-module id="coffer-unit-detail-list">

  <template>

    <style>

      :host {
        display: block;
      }
      .detail {
        margin:0;
        width: 100%;
        transition: opacity 0.4s;
        opacity: 1;
      }
      #content {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
      }
      paper-card::shadow iron-image{
        width:initial !important;
        max-height:450px;
        margin-top:65px;
      }
      paper-card{
        @apply(--things-coffer-detail-card);
      }
      paper-card::shadow .title-text{
        top:10px;
        left:15px;
        bottom:initial !important;
        padding:0 !important;
        color:var(--app-primary-color) !important;
        font-size:20px !important;
        font-weight:bold !important;
      }
      paper-fab{
        @apply(--things-coffer-fab)
      }
      paper-fullscreen-dialog{
        height:80% !important;
        margin-top:9%;
        overflow:hidden;
      }
      .rate-info{
        @apply(--things-coffer-desc);
        position:absolute;
        top:40px;
        left:15px;
      }
      .rate-info iron-icon{
        @apply(--things-coffer-info-icon);
      }
      .card-actions{
        background-color:#f6f6f6;
        text-align:left;
      }
      .card-actions paper-icon-button{
        position:absolute;
        right:0;
        margin-top:-7px;
      }
      .card-actions h2{
        margin:0;
        padding:5px 0 0 0;
        font-size:14px;
        color:var(--app-primary-text-color);
      }
      .card-actions p{
        color:var(--app-primary-text-color);
        opacity:.7;
        margin:0 0 0px 0;
        font-size:12px;
      }
      ul{
        list-style: none;
        background-color:#f6f6f6;
        margin:0;
        padding:5px 0 0 0;
      }
      .timeline-item{
        background:url(/images/bg-timeline.png) 17px 0 repeat-y #f6f6f6;
        border-bottom:1px solid #ddd;
        overflow:hidden;
        clear:both;
        padding:9px 0 8px 0;
      }
      .timeline-item:nth-child(even){
        background-color:rgba(255,255,255,.8);
      }
      .timeline-item .timedot{
        float:left;
        width:70px;
      }
      .timedot{
        padding-left:30px;
        font-size:11px;
        color:var(--app-primary-text-color);
      }
      .timedot span{
        width:6px;height:6px;
        margin:10px 5px 0 -18px;
        background-color:#fff;
        display:block;
        position:absolute;
        border-radius:7px;
        border:solid 3px #acacac;
      }
      .timeline-item .content{

        font-size:15px;
        color:var(--app-primary-text-color);
        line-height:1.3
      }
      .timeline-item .content strong{
        display:block;
      }
      .discard .timedot span{border-color:var(--app-primary-color);}
      .discard .content strong{color:var(--app-primary-color);}
      .create .timedot span{border-color:#87c833;}
      .create .content strong{color:#87c833;}
      .timeline-item .content div{
        float:right;
        margin:3px 7px 0 0;
      }
      .timeline-item .edit{
        background:url(/images/icon-more.png) 50% -200px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
      .timeline-item .delete{
        background:url(/images/icon-more.png) 50% -250px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
    </style>

    <!--
      app-route provides the name of the category and the item.
    -->
    <app-route
        route="[[route]]"
        pattern="/:category/:item"
        data="{{routeData}}"></app-route>

    <!--
      shop-category-data provides the item data for a given category and item name.
    -->
    <coffer-category-data
        id="categoryData"
        category-name="[[routeData.category]]"
        item-name="[[routeData.item]]"
        item="{{item}}"
        failure="{{failure}}"></coffer-category-data>


    <coffer-unit-localstorage-data id="unit" item-name="[[routeData.item]]" unit-item="{{test}}"></coffer-unit-localstorage-data>
    <coffer-timeline-localstorage-data id="timeline" unit-name="[[routeData.item]]" timeline-arr="{{timelineArr}}"></coffer-timeline-localstorage-data>

    <div id="content">
      <div class="detail">
        <template is="dom-if" if="{{_showUnit(item)}}">
          <paper-card heading="Top western road trips" image="[[item.image]]" class="white" elevation="0">
            <div class="rate-info">
             <iron-icon icon="icons:assignment"></iron-icon>[[item.category]]
             <iron-icon icon="icons:alarm-on"></iron-icon><span>12</span>
            </div>
            <div class="card-actions">
              <paper-icon-button icon="hardware:keyboard-arrow-up" title="more info" on-tap="_toggle">
              </paper-icon-button>
              <iron-collapse id="moreInfo" style="width:100%;">
                <div class="description">
                  <h2>Description</h2>
                  <p>[[item.description]]</p>
                  <!-- <p id="desc"></p> -->
                </div>
              </iron-collapse>
            </div>
          </paper-card>
        </template>

        <template is="dom-if" if="{{_showUnit(test)}}">
          <paper-card heading="Top western road trips" image="[[test.image]]" class="white">
            <div class="card-actions">
              <paper-icon-button icon="hardware:keyboard-arrow-up" title="more info" on-tap="_toggleLocal" style="float:right;">
              </paper-icon-button>
              <iron-collapse id="moreInfoLocal" style="width:100%;">
                <div class="description">
                  <h2>Description</h2>
                  <p>[[test.description]]</p>
                </div>
              </iron-collapse>
            </div>
          </paper-card>
        </template>
        
        <ul>
        <template is="dom-repeat" items="{{_toArray(item.details)}}" as="testArr">
          <li class="timeline-item"><!--type : create-생성, discard-폐기, 없음-기본 -->
            <div class="timedot">
              <span></span>
              2016.06.30<br>18:30:00
            </div>
            <div class="content">
              <strong>{{testArr.value.timelineTitle}}</strong>
              {{testArr.value.timelineMessage}}
              <div>
                <a href="#" class="edit"></a>
                <a href="#" class="delete"></a>
              </div>
            </div>
          </li>
        </template>
        </ul>

        <template is="dom-repeat" items="[[_toArray(timelineArr)]]" as="entry">
          <a href$="[[_getItemHref(entry, item)]]">
            Timeline Title: <span>{{entry.value.timelineTitle}}</span></a>
            <br> Timeline Message: <span>{{entry.value.timelineMessage}}</span>
            <br>
            <hr>
        </template>
      </div>
      <paper-fab noink id="add-timeline" icon="add" title="add timeline"></paper-fab>
      <paper-fullscreen-dialog id="new-timeline">
        <h2>New Timeline</h2>
        <paper-button id="create-timeline" affirmative dialog-confirm>create</paper-button>
        <coffer-unit-timeline-new id="new-timeline-data"></coffer-unit-timeline-new>
      </paper-fullscreen-dialog>
    </div>

  </template>

  <script>

    Polymer({

      is: 'coffer-unit-detail-list',

      properties: {

        item: Object,

        route: Object,

        routeData: Object,

        visible: Boolean,

        offline: {
          type: Boolean,
          observer: '_offlineChanged'
        },

        failure: Boolean,

        unit: Array,

        timeline: Array,

        timelineArr: Array,

        test: Object

      },

      listeners: {
        'add-timeline.tap': 'onTapAddTimeline',
        'new-timeline.iron-overlay-closed': 'onNewTimelineDialogClosed'
      },

      observers: [
        '_itemChanged(item, visible)'
      ],

      attributeChanged: function() {
        this.$.unit.reload();
      },

      _itemChanged: function(item, visible) {
        if (visible) {
          this.debounce('item-change', function(e) {
            // var text = item ? item.description : '';
            // this.$.desc.innerHTML = this._unescapeText(text);

            this.fire('change-section', {
              category: item.category,
              title: item.title
            });
          });
        }
      },

      _showUnit: function(item) {
        return item != null;
      },

      _tryReconnect: function() {
        this.$.categoryData.refresh();
      },

      _offlineChanged: function(offline) {
        if (!offline) {
          this._tryReconnect();
        }
      },

      _toArray: function(obj) {
        if(obj != null) {
          return Object.keys(obj).map(function(key) {
            return {
              value: obj[key]
            };
          });
        }
        
      },

      _toggle: function(e) {
        var moreInfo = e.currentTarget.parentElement.querySelector('iron-collapse');
        var iconButton = Polymer.dom(event).localTarget;
        iconButton.icon = moreInfo.opened ? 'hardware:keyboard-arrow-up'
                                          : 'hardware:keyboard-arrow-down';
        moreInfo.toggle();
      },

      _toggleLocal: function(e) {
        var moreInfoLocal = e.currentTarget.parentElement.querySelector('iron-collapse');
        var iconButton = Polymer.dom(event).localTarget;
        iconButton.icon = moreInfoLocal.opened ? 'hardware:keyboard-arrow-up'
                                          : 'hardware:keyboard-arrow-down';
        moreInfoLocal.toggle();
      },

      onTapAddTimeline: function(e) {
        this.$["new-timeline"].open();
      },

      createResource: function(data) {
        var result = {
          'unitName' : this.routeData.item,
          'timelineTitle' : data.title,
          'timelineMessage' : data.message
        };
        this.$.timeline.addItem(result);
        this.timelineArr = this.$.timeline.refresh(this.routeData.item);
      },

      onNewTimelineDialogClosed: function(e) {
        if(!e.detail.confirmed)
          return

        this.createResource(this.$['new-timeline-data'].object);
      },

      _getItemHref: function(testArr, item) {
        return item.name ? ['/unit-detail', item.category, item.name, testArr.value.testName].join('/') : null;
      }
    });

  </script>

</dom-module>
