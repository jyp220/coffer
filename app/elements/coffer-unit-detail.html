<link rel="import" href="coffer-category-data.html">
<link rel="import" href="coffer-select.html">

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<link rel="import" href="../bower_components/sc-upload/sc-upload.html">

<dom-module id="coffer-unit-detail">
  <template>

    <style include="coffer-select">

      :host {
        display: block;
      }

      h1 {
        font-size: 24px;
        font-weight: 500;
        line-height: 28px;
        margin: 0;
      }

      .price {
        margin: 16px 0 40px;
        font-size: 16px;
        color: var(--app-secondary-color);
      }

      .description {
        margin: 32px 0;
      }

      .description > h2 {
        margin: 16px 0;
        font-size: 13px;
      }

      .description > p {
        margin: 0;
        color: var(--app-secondary-color);
      }

      .pickers {
        @apply(--layout-vertical);
        border-top: 1px solid #ccc;
      }

      coffer-select > select {
        font-size: 16px;
        padding: 16px 24px 16px 70px;
      }

      @media (max-width: 767px) {

        #content {
          @apply(--layout-vertical);
          @apply(--layout-center);
        }

        .detail {
          box-sizing: border-box;
          margin: 32px 0;
          padding: 0 24px;
          width: 100%;
          max-width: 600px;
        }

        h1 {
          font-size: 20px;
          line-height: 24px;
        }

        .price {
          font-size: inherit;
          margin: 12px 0 32px;
        }

      }

    </style>

    <app-route
        route="[[route]]"
        pattern="/:category/:category/:item"
        data="{{routeData}}"></app-route>

    <coffer-category-data categories="{{categories}}"></coffer-category-data>

    <coffer-category-data
        id="categoryData"
        category="{{category}}"
        category-name="[[routeData.category]]"
        item-name="[[routeData.item]]"
        item="{{item}}"
        failure="{{failure}}"></coffer-category-data>

    <div id="content">
      <div class="detail">
        <paper-input label="name"
                 value="{{name::input}}"
                 auto-validate
                 pattern="[a-zA-Z-0-9]*"
                 error-message="letters & dash only!">
        </paper-input>

        <paper-textarea label="description"
                        value="{{description::input}}">
        </paper-textarea>


        <div class="pickers">
          <coffer-select>
            <label id="cofferLabel" prefix>Coffer</label>
            <select id="cofferSelect" aria-labelledby="cofferLabel">
              <template is="dom-repeat" items="{{_toArray(categories)}}" as="category">
                <option value="[[category.value.name]]">{{category.value.title}}</option>
              </template>
            </select>
            <coffer-md-decorator aria-hidden="true">
              <coffer-underline></coffer-underline>
            </coffer-md-decorator>
          </coffer-select>
        </div>
      </div>
    </div>

    <sc-upload></sc-upload>

    <paper-textarea label="content" value="{{content::input}}"></paper-textarea>
    <paper-textarea label="detail" value="{{detail::input}}"></paper-textarea>
    <paper-textarea label="memo" value="{{memo::input}}"></paper-textarea>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'coffer-unit-detail',

        properties: {
          object: {
            type: Object,
            value: {},
            notify: true,
            computed: '_computeObject(name,description,content,detail,memo)'
          },

          item: Object,

          route: Object,

          routeData: Object,

          visible: Boolean,

          offline: {
            type: Boolean,
            observer: '_offlineChanged'
          },

          failure: Boolean
        },

        listeners: {
        },

        observers: [
          '_itemChanged(item, visible)'
        ],

        _itemChanged: function(item, visible) {
          if (visible) {
            this.debounce('item-change', function() {
              // The item description contains escaped HTML (e.g. "&lt;br&gt;"), so we need to
              // unescape it ("<br>") and set it as innerHTML.
              var text = item ? item.description : '';

              this.fire('change-section', {
                category: item.category,
                title: item.title
              });
            });
          }
        },

        _tryReconnect: function() {
          this.$.categoryData.refresh();
        },

        _offlineChanged: function(offline) {
          if (!offline) {
            this._tryReconnect();
          }
        },

        created: function() {
        },

        _computeObject(name, description, content, detail, memo) {
          return {
            name: name,
            description: description,
            content: content,
            detail: detail,
            memo: memo
          }
        },

        _toArray: function(obj) {
          if(obj != null) {
            return Object.keys(obj).map(function(key) {
              return {
                value: obj[key]
              };
            });
          }
          
        }

      });
    })();
  </script>
</dom-module>
