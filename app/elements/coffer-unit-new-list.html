<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<dom-module id="coffer-unit-new-list">
  <template>

    <style>
      .imageDelete{
        background:url("../images/icon-more.png") 50% -250px no-repeat;
        width:25px;height:16px;
        display:block;
        float:left;
      }
      ::shadow .fileUpload label {
        display: inline-block;
        padding: .5em .75em;
        color: #999;
        font-size: inherit;
        line-height: normal;
        vertical-align: middle;
        background-color: #fdfdfd;
        cursor: pointer;
        border: 1px solid #ebebeb;
        border-bottom-color: #e2e2e2;
        border-radius: .25em;
      }
      /* 파일 필드 숨기기 */
      ::shadow .fileUpload input[type="file"] {  
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip:rect(0,0,0,0);
        border: 0;
      }
    </style>

    <things-ajax
      auto
      id="get-resource"
      method="GET"
      resource-url="coffers"
      last-response="{{cofferResource}}">
    </things-ajax>

    <form is="iron-form" id="unitNewForm" method="post" enctype="multipart/form-data">
      <paper-input name="name" label="name" type="string" value="{{name}}"></paper-input>
      <paper-textarea name="content" label="content" type="string" value="{{content}}"></paper-textarea>
      <paper-dropdown-menu label="group" name="group" 
                         value="{{group}}"
                         vertical-align="top"
                         horizontal-align="left">

        <paper-menu class="dropdown-content" selected="{{selectedGroup(group)}}">
          <template is="dom-repeat" items="{{cofferResource.items}}">
            <paper-item>{{item.name}}</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>
      <br>
      <div id="addedUnitListDiv"></div>
      <!-- <input type="button" value=" 추가 " on-click="add_item"><br> -->

      <paper-button id="submitButton" raised on-click="_unitCreate">Submit</paper-button>
      <paper-button id="closeButton" raised on-click="_unitClose">close</paper-button>
    </form>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'coffer-unit-new-list',

        properties: {
          cofferResource: Object,

          cofferId: String,

          data: String,

          count: {
            type: Number,
            value: 0
          },

          maxCount: {
            type: Number,
            value: 0
          }
        },

        observers: [
          '_thumbnailChanged(unitThumbnail)'
        ],

        behaviors: [
          Things.GlobalBehavior
        ],

        _thumbnailChanged: function(thumbnail) {
          if(thumbnail == "") {
            this.add_item();
          }
        },

        add_item: function(){
          if(this.maxCount < 3) {
            var addedUnitListDiv = this.$.addedUnitListDiv;
            var self = this;
            var idx = this.count;

            var label = document.createElement('label');
            label.setAttribute('for', 'unitgetfile' + this.count);
            label.innerHTML = "<img id='unitthumbnail"+this.count+"' src='' width='100'></label>";

            var file = document.createElement('input');
            file.id = 'unitgetfile' + this.count;
            file.name = 'file';
            file.setAttribute('label', 'file');
            file.type = 'file';
            file.onchange = function(){self.fileOnChange(idx)}

            var btn = document.createElement('input');
            btn.hidden = 'true';
            btn.id = 'unitBtn' + this.count;
            btn.type = 'button';
            btn.onclick = function(){self._deleteFile(idx)}

            var addedDiv = document.createElement("div"); // 폼 생성
            addedDiv.id = "added_" + this.count; // 폼 Div에 ID 부여 (삭제를 위해)
            addedDiv.setAttribute('class', 'fileUpload');
            addedDiv.appendChild(btn);
            addedDiv.appendChild(label);
            addedDiv.appendChild(file);
            addedUnitListDiv.appendChild(addedDiv); // 삽입할 DIV에 생성한 폼 삽입

            this.count++;
            this.maxCount++;
          }
          
        },

        createThumbnail: function(readerUri, idx) {
          //썸네일 이미지 생성
          var tempImage = new Image(); //drawImage 메서드에 넣기 위해 이미지 객체화
          tempImage.src = readerUri; //data-uri를 이미지 객체에 주입
          var self = this;
          tempImage.onload = function() {
            //리사이즈를 위해 캔버스 객체 생성
            var canvas = document.createElement('canvas');
            var canvasContext = canvas.getContext("2d");
            
            //캔버스 크기 설정
            canvas.width = 100; //가로 100px
            canvas.height = 100; //세로 100px
            
            //이미지를 캔버스에 그리기
            canvasContext.fillStyle = "#FFFFFF";
            canvasContext.fillRect(0, 0, 100, 100);
            canvasContext.drawImage(this, 0, 0, 100, 100);
            //캔버스에 그린 이미지를 다시 data-uri 형태로 변환
            var dataURI = canvas.toDataURL("image/jpeg");
            //썸네일 이미지 보여주기
            
            var thumbnailId = 'unitthumbnail' + idx;
            document.getElementById(thumbnailId).src = dataURI;
          };
          this.add_item();
        },

        fileOnChange: function(idx) {
          var fileId = 'unitgetfile' + idx;
          var thumbnailId = 'unitthumbnail' + idx;
          var deleteBtnId = 'unitBtn' + idx;
          var fileList = document.getElementById(fileId).files;
          var self = this;
          var reader = new FileReader();

          if(fileList.length > 0) {
            reader.readAsDataURL(fileList [0]);
          } else {
            document.getElementById(thumbnailId).src = "";
          }
          document.getElementById(deleteBtnId).hidden = false;
          document.getElementById(fileId).disabled = true;
          reader.onload = function  () {
            self.createThumbnail(reader.result, idx);
          };
        },

        selectedGroup: function(group) {
          if(group == "" || !this.cofferResource)
            return

          for(var i = 0;i < this.cofferResource.items.length;i++) {
            if(this.cofferResource.items[i].name == group) {
              this.cofferId = this.cofferResource.items[i].id;
              return i;
            }
          }
        },

        _unitClose:function(e) {
          this._reset();
          this.fire(this.data + '-close', { title: 'close' });
        },

        _unitCreate: function(e) {
          var divList = document.getElementById('addedUnitListDiv');
          for(var i = 0 ; i < divList.childNodes.length ; i++) {
            divList.childNodes[i].childNodes[2].disabled = false;
          }

          var form = this.$.unitNewForm;
          var oData = new FormData(form);
          var self = this;

          var result = {
            'name' : form.elements['name'].value,
            'coffer_id' : this.cofferId,
            'content' : form.elements['content'].value,
          };

          oData.append('item', JSON.stringify(result));
          var myRequest = new XMLHttpRequest();
          myRequest.onreadystatechange = function(){
            if(myRequest.readyState == 4 && (myRequest.status == 200 || myRequest.status == 201)){
              self._reset();
              self.fire(self.data + '-success', { title: 'close' });
            } 
          };

          myRequest.withCredentials = true;
          myRequest.open('post', this.get('globals.baseUrl') + '/units',true);
          myRequest.send(oData);
        },

        _deleteFile: function(idx) {
          document.getElementById('addedUnitListDiv').removeChild(document.getElementById('added_' + idx));
          this.maxCount--;
        },

        _reset: function() {
          this.name = '';
          this.content = '';
          this.group = '';

          var divList = document.getElementById('addedUnitListDiv');
          while ( divList.hasChildNodes() )
          {
            divList.removeChild( divList.firstChild );       
          }
          this.unitThumbnail = '';
          this.maxCount = 0;
          this.count = 0;
        }

      })
    })();
  </script>
</dom-module>
